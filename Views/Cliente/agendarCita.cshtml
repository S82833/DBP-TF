@{
    ViewData["Title"] = "Agendar Cita";
    var mensajeHorario = ViewBag.MensajeHorario as string;
}
<link rel="stylesheet" href="~/css/Odontobrass-Citas.css" asp-append-version="true" />

<div class="container section">
    <div class="form-card">

        <div class="form-group">
            <label>Especialidad</label>
            @Html.DropDownList(
            "Especialidad",                          // name del campo
                        (SelectList)ViewBag.Especialidades,      // datos + seleccionado
                        "-- Seleccione --",
                        new { @class = "form-control", id = "Especialidad" }
                        )
        </div>

        <div class="form-group">
            <label>Médico</label>
            @Html.DropDownList(
                        "Medico",
                        (SelectList)ViewBag.Medicos,
                        "-- Seleccione --",
                        new { @class = "form-control", id = "Medico" }
                        )
        </div>

        <div class="form-group">
            <label>Fecha</label>
            <input type="date" name="Fecha" id="Fecha" class="form-control" />
        </div>

        @if (ViewBag.Horarios != null)
        {
            <div class="form-group">
                <label>Horario disponible</label>
                @Html.DropDownList(
                "HorarioSeleccionado",
                        (SelectList)ViewBag.Horarios,
                        "-- Seleccione --",
                        new { @class = "form-control", id = "Horario" }
                        )
        </div>
                }
        else if (!string.IsNullOrEmpty(mensajeHorario))
        {
            <div class="alert alert-warning">@mensajeHorario</div>
        }

        <div class="btn-row">
            <button class="btn btn-primary">Confirmar</button>
            <a class="btn btn-secondary" asp-controller="Inicio" asp-action="Index">Cancelar</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cuando cambia la especialidad, recarga la página con el parámetro para filtrar médicos
        document.getElementById('Especialidad')?.addEventListener('change', function() {
          const esp = this.value;
          const url = new URL(window.location.href);
          if (esp) {
            url.searchParams.set('especialidad', esp);
          } else {
            url.searchParams.delete('especialidad');
          }
          // si había idMedico, lo limpiamos porque ya no aplica al cambiar especialidad
          url.searchParams.delete('idMedico');
          window.location.href = url.toString();
        });

        document.getElementById('Medico')?.addEventListener('change', function() {
          const medicoId = this.value;
          const url = new URL(window.location.href);
          if (medicoId) {
            url.searchParams.set('idMedico', medicoId);
          } else {
            url.searchParams.delete('idMedico');
          }
          window.location.href = url.toString();
        });

        const fechaInput = document.getElementById("Fecha");
        const medicoSelect = document.getElementById("Medico");
        const horarioContainer = document.getElementById("Horario");

        fechaInput?.addEventListener("change", async function () {
            const fecha = this.value;
            const idMedico = medicoSelect.value;

            if (!fecha || !idMedico) return;

            const url = `/Cliente/ObtenerHorarios?idMedico=${idMedico}&fecha=${fecha}`;
            const response = await fetch(url);
            const data = await response.json();

            const horarioDiv = document.getElementById("Horario");
            horarioDiv.innerHTML = ""; // limpiar

            if (data.success) {
                // llenar el dropdown con las horas
                data.horarios.forEach(hora => {
                    const opt = document.createElement("option");
                    opt.value = hora;
                    opt.textContent = hora;
                    horarioDiv.appendChild(opt);
                });
            } else {
                const alert = document.createElement("div");
                alert.className = "alert alert-warning mt-2";
                alert.textContent = data.mensaje;
                horarioDiv.parentNode.appendChild(alert);
            }
        });

    </script>
}
